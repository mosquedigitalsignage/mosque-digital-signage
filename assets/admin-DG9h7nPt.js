import{initFirebase as I,signInWithGoogle as h,signOut as E,onAuthStateChanged as p,normalizeAdminRecord as B,fetchAdminRecord as f,fetchMosqueConfig as b,createMosque as C,addMosqueToAdmin as w,createAdminRecord as q,updateMosque as u}from"./firebase-vyUQ6H15.js";const i={signIn:document.getElementById("sign-in-screen"),loading:document.getElementById("loading-screen"),newMosque:document.getElementById("new-mosque-screen"),dashboard:document.getElementById("dashboard-screen")};function m(e){Object.values(i).forEach(t=>{t&&(t.style.display="none")}),i[e]&&(i[e].style.display="")}let c=null,s=null,a=null,o=null;function y(){I(),document.getElementById("google-sign-in-btn")?.addEventListener("click",async()=>{try{await h()}catch(n){console.error("Sign-in failed:",n)}}),document.getElementById("sign-out-btn")?.addEventListener("click",async()=>{await E(),m("signIn")}),p(async n=>{n?(c=n,m("loading"),await x()):(c=null,s=null,a=null,o=null,m("signIn"))}),document.getElementById("new-mosque-form")?.addEventListener("submit",M),document.getElementById("edit-mosque-form")?.addEventListener("submit",A),document.getElementById("add-announcement-btn")?.addEventListener("click",g),document.getElementById("new-announcement-text")?.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),g())});const e=document.getElementById("announcement-color"),t=document.getElementById("announcement-color-value");e?.addEventListener("input",()=>{t.textContent=e.value}),e?.addEventListener("change",F),document.getElementById("reset-announcement-color-btn")?.addEventListener("click",S),document.getElementById("save-custom-ayats-btn")?.addEventListener("click",D),document.getElementById("reset-ayats-btn")?.addEventListener("click",k),document.getElementById("preview-btn")?.addEventListener("click",()=>{if(o){const n=window.location.origin+window.location.pathname.replace(/\/admin\.html$/,"/");window.open(`${n}?mosque=${o}`,"_blank")}}),document.getElementById("copy-url-btn")?.addEventListener("click",()=>{const n=document.getElementById("dash-display-url");n&&navigator.clipboard.writeText(n.value).then(()=>{const l=document.getElementById("copy-url-btn");l.textContent="Copied!",setTimeout(()=>{l.textContent="Copy"},2e3)})})}async function x(){try{s=B(await f(c.uid)),s&&s.mosqueIds.length>0?(o=s.mosqueIds[0],a=await b(o),a?(v(),m("dashboard")):m("newMosque")):m("newMosque")}catch(e){console.error("Failed to load admin data:",e),m("newMosque")}}async function M(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]');t.disabled=!0,t.textContent="Creating...";try{o=crypto.randomUUID();const n={id:o,createdAt:new Date().toISOString(),createdBy:c.uid,mosque:{name:document.getElementById("nm-name").value,shortName:document.getElementById("nm-short-name").value,headerText:document.getElementById("nm-header").value||`Welcome to ${document.getElementById("nm-name").value}`,pageTitle:document.getElementById("nm-page-title").value||`${document.getElementById("nm-name").value} Display`},location:{zipcode:document.getElementById("nm-zipcode").value,country:document.getElementById("nm-country").value||"US",timezone:document.getElementById("nm-timezone").value||"America/New_York"},prayerTimes:{calculationMethod:document.getElementById("nm-calc-method").value,jummahTime:document.getElementById("nm-jummah").value,fallbackTimes:{Fajr:"5:30 AM",Dhuhr:"1:00 PM",Asr:"4:30 PM",Maghrib:"7:00 PM",Isha:"8:30 PM"}},googleDrive:{rootFolderId:document.getElementById("nm-drive-folder").value},display:{slideshowIntervalMs:8e3,ayatRotationIntervalMs:2e4,theme:{headerBg:"rgba(26,26,26,0.8)",panelBg:"rgba(26,26,26,0.8)",accentColor:"#3b82f6",textColor:"#ffffff"}},ayatHadith:"default"};await C(o,n),s&&s.mosqueIds?(await w(c.uid,o),s.mosqueIds.push(o)):(await q(c.uid,{mosqueIds:[o],email:c.email,role:"mosque_admin",createdAt:new Date().toISOString()}),s={mosqueIds:[o],email:c.email,role:"mosque_admin"}),a=n,v(),m("dashboard")}catch(n){console.error("Failed to create mosque:",n),t.disabled=!1,t.textContent="Create Mosque",alert("Failed to create mosque. Please try again.")}}function v(){if(!a)return;const e=a;document.getElementById("dash-mosque-name").textContent=e.mosque?.name||"Mosque Dashboard";const t=window.location.origin+window.location.pathname.replace(/\/admin\.html$/,"/");document.getElementById("dash-display-url").value=`${t}?mosque=${o}`,document.getElementById("ed-name").value=e.mosque?.name||"",document.getElementById("ed-short-name").value=e.mosque?.shortName||"",document.getElementById("ed-header").value=e.mosque?.headerText||"",document.getElementById("ed-page-title").value=e.mosque?.pageTitle||"",document.getElementById("ed-zipcode").value=e.location?.zipcode||"",document.getElementById("ed-country").value=e.location?.country||"",document.getElementById("ed-timezone").value=e.location?.timezone||"",document.getElementById("ed-calc-method").value=e.prayerTimes?.calculationMethod||"ISNA",document.getElementById("ed-jummah").value=e.prayerTimes?.jummahTime||"",document.getElementById("ed-drive-folder").value=e.googleDrive?.rootFolderId||"",document.getElementById("ed-slideshow-interval").value=e.display?.slideshowIntervalMs||8e3,document.getElementById("ed-ayat-interval").value=e.display?.ayatRotationIntervalMs||2e4,r();const n=e.display?.announcementColor||e.display?.theme?.accentColor||"#3b82f6";document.getElementById("announcement-color").value=n,document.getElementById("announcement-color-value").textContent=n;const l=e.customAyats||[];document.getElementById("custom-ayats-textarea").value=l.map(d=>d.en).join(`
`)}async function A(e){e.preventDefault();const t=document.getElementById("save-status"),n=e.target.querySelector('button[type="submit"]');n.disabled=!0,n.textContent="Saving...",t.textContent="",t.className="save-status";try{const l={mosque:{name:document.getElementById("ed-name").value,shortName:document.getElementById("ed-short-name").value,headerText:document.getElementById("ed-header").value,pageTitle:document.getElementById("ed-page-title").value},location:{zipcode:document.getElementById("ed-zipcode").value,country:document.getElementById("ed-country").value,timezone:document.getElementById("ed-timezone").value},prayerTimes:{calculationMethod:document.getElementById("ed-calc-method").value,jummahTime:document.getElementById("ed-jummah").value,fallbackTimes:a?.prayerTimes?.fallbackTimes||{}},googleDrive:{rootFolderId:document.getElementById("ed-drive-folder").value},display:{slideshowIntervalMs:parseInt(document.getElementById("ed-slideshow-interval").value,10)||8e3,ayatRotationIntervalMs:parseInt(document.getElementById("ed-ayat-interval").value,10)||2e4,theme:{headerBg:"rgba(26,26,26,0.8)",panelBg:"rgba(26,26,26,0.8)",accentColor:"#3b82f6",textColor:"#ffffff"}}};await u(o,l),a={...a,...l},document.getElementById("dash-mosque-name").textContent=l.mosque.name||"Mosque Dashboard",t.textContent="Changes saved successfully!",t.className="save-status success"}catch(l){console.error("Failed to save changes:",l),t.textContent="Failed to save. Please try again.",t.className="save-status error"}finally{n.disabled=!1,n.textContent="Save Changes",setTimeout(()=>{t.textContent=""},3e3)}}function r(){const e=document.getElementById("announcements-list");if(!e)return;const t=a?.announcements||[];if(t.length===0){e.innerHTML='<p class="empty-text">No announcements yet.</p>';return}e.innerHTML="",t.forEach((n,l)=>{const d=document.createElement("div");d.className="managed-item"+(n.enabled?"":" disabled"),d.innerHTML=`
      <span class="managed-item-text">${n.text}</span>
      <div class="managed-item-actions">
        <button class="btn btn-sm btn-outline" data-action="toggle" data-idx="${l}">
          ${n.enabled?"Disable":"Enable"}
        </button>
        <button class="btn btn-sm btn-danger" data-action="delete" data-idx="${l}">Delete</button>
      </div>
    `,e.appendChild(d)}),e.querySelectorAll('[data-action="toggle"]').forEach(n=>{n.addEventListener("click",()=>T(parseInt(n.dataset.idx,10)))}),e.querySelectorAll('[data-action="delete"]').forEach(n=>{n.addEventListener("click",()=>L(parseInt(n.dataset.idx,10)))})}async function g(){const e=document.getElementById("new-announcement-text"),t=e.value.trim();if(!t)return;const n=a?.announcements||[];n.push({text:t,enabled:!0});try{await u(o,{announcements:n}),a.announcements=n,e.value="",r()}catch(l){console.error("Failed to add announcement:",l),alert("Failed to add announcement.")}}async function T(e){const t=[...a?.announcements||[]];if(t[e]){t[e]={...t[e],enabled:!t[e].enabled};try{await u(o,{announcements:t}),a.announcements=t,r()}catch(n){console.error("Failed to toggle announcement:",n)}}}async function L(e){const t=[...a?.announcements||[]];t.splice(e,1);try{await u(o,{announcements:t}),a.announcements=t,r()}catch(n){console.error("Failed to delete announcement:",n)}}async function F(){const e=document.getElementById("announcement-color").value;try{await u(o,{display:{...a.display,announcementColor:e}}),a.display={...a.display,announcementColor:e}}catch(t){console.error("Failed to save announcement color:",t)}}async function S(){const e=a?.display?.theme?.accentColor||"#3b82f6";document.getElementById("announcement-color").value=e,document.getElementById("announcement-color-value").textContent=e;try{await u(o,{display:{...a.display,announcementColor:e}}),a.display={...a.display,announcementColor:e}}catch(t){console.error("Failed to reset announcement color:",t)}}async function D(){const e=document.getElementById("custom-ayats-textarea"),t=document.getElementById("ayat-save-status"),l=e.value.split(`
`).map(d=>d.trim()).filter(d=>d.length>0).map(d=>({en:d}));try{await u(o,{customAyats:l}),a.customAyats=l,t.textContent=`Saved ${l.length} custom ayat(s).`,t.className="save-status success"}catch(d){console.error("Failed to save custom ayats:",d),t.textContent="Failed to save. Please try again.",t.className="save-status error"}setTimeout(()=>{t.textContent=""},3e3)}async function k(){const e=document.getElementById("custom-ayats-textarea"),t=document.getElementById("ayat-save-status");try{await u(o,{customAyats:[]}),a.customAyats=[],e.value="",t.textContent="Reset to default ayats.",t.className="save-status success"}catch(n){console.error("Failed to reset ayats:",n),t.textContent="Failed to reset. Please try again.",t.className="save-status error"}setTimeout(()=>{t.textContent=""},3e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();
